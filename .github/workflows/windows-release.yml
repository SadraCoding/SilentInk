name: Build Windows EXE & Release

on:
  push:
    tags:
      - 'v*'           # Triggers on tags like v1.0, v1.1, silentink-v1.0, etc.
  workflow_dispatch:   # Allows manual trigger from Actions tab

permissions:
  contents: write      # Required to create releases & upload assets

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'   # or 3.12 — choose what your project needs

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pillow cryptography colorama
          # If you have requirements.txt → add:  pip install -r requirements.txt

      - name: Build with PyInstaller
        run: |
          pyinstaller ^
            --onefile ^
            --name silentink-v1.0-win ^
            --console ^
            --hidden-import pillow ^
            --hidden-import cryptography ^
            --hidden-import colorama ^
            --icon media/icon.png ^
            --clean ^
            silent_ink.py

      - name: Rename artifact (optional - nicer name with version)
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"           # e.g. v1.0
          $tag = $tag -replace '^v', ''             # remove v prefix if present
          Copy-Item -Path ".\dist\silentink-v1.0-win.exe" -Destination ".\dist\silentink-$tag-win.exe" -Force

      - name: Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/silentink-*.exe                # wildcard works if you renamed
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true