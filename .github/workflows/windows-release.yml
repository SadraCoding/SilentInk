name: Build Windows EXE & Release

on:
  push:
    tags:
      - 'v*'           # Triggers on tags like v1.0, v1.1, v2.0-beta, silentink-v1.0 etc.
  workflow_dispatch:   # Allows manual trigger from the Actions tab

permissions:
  contents: write      # Required to create releases and upload assets

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'   # Change to '3.12' if you prefer / need newer features

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pillow cryptography colorama
          # If you have a requirements.txt file, uncomment the next line instead:
          # pip install -r requirements.txt

      - name: Build with PyInstaller
        shell: cmd
        run: |
          pyinstaller ^
            --onefile ^
            --name silentink-win ^
            --console ^
            --hidden-import pillow ^
            --hidden-import cryptography ^
            --hidden-import colorama ^
            --icon media/icon.png ^
            --clean ^
            silent_ink.py

      - name: Rename artifact to include version from tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $tag = $tag -replace '^v', ''             # remove 'v' prefix if present
          $oldFile = ".\dist\silentink-win.exe"
          $newFile = ".\dist\silentink-$tag-win.exe"
          
          if (Test-Path $oldFile) {
            Copy-Item -Path $oldFile -Destination $newFile -Force
            Write-Output "Renamed to: silentink-$tag-win.exe"
          } else {
            Write-Error "EXE not found: $oldFile"
            exit 1
          }

      - name: Upload EXE to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/silentink-*-win.exe
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true